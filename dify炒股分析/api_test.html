<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†æAPIæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #27ae60;
        }
        .error {
            background: #ffeaa7;
            border: 1px solid #e17055;
            color: #e17055;
        }
        .info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è‚¡ç¥¨åˆ†æAPIæµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <div class="test-title">1. å¥åº·æ£€æŸ¥</div>
            <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <div id="health-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯</div>
            <input type="text" id="stock-code-info" value="600132" placeholder="è‚¡ç¥¨ä»£ç ">
            <button onclick="testStockInfo()">è·å–è‚¡ç¥¨ä¿¡æ¯</button>
            <div id="stock-info-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. å¸‚åœºçŠ¶æ€</div>
            <button onclick="testMarketStatus()">è·å–å¸‚åœºçŠ¶æ€</button>
            <div id="market-status-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. ç»¼åˆè‚¡ç¥¨åˆ†æ (âš ï¸ å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ)</div>
            <input type="text" id="stock-code-analysis" value="600132" placeholder="è‚¡ç¥¨ä»£ç ">
            <button onclick="testStockAnalysis()">å¼€å§‹åˆ†æ</button>
            <div id="analysis-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“ Difyé…ç½®ä¿¡æ¯</div>
            <div class="info result" style="display:block;">
URL: http://10.7.139.26:8001/analyze-stock
æ–¹æ³•: POST
Content-Type: application/json
Authorization: Bearer xue1234
è¶…æ—¶: 120ç§’
è¯·æ±‚ä½“: {
  "stock_code": "{{#stock_code#}}",
  "market_type": "A",
  "period": "30"
}
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://10.7.139.26:8001';

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        function showLoading(elementId, message = 'æ­£åœ¨è¯·æ±‚...') {
            showResult(elementId, message, 'loading');
        }

        async function testHealth() {
            const resultId = 'health-result';
            showLoading(resultId, 'æ­£åœ¨æ£€æŸ¥APIå¥åº·çŠ¶æ€...');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultId, `âœ… å¥åº·æ£€æŸ¥é€šè¿‡\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(resultId, `âŒ å¥åº·æ£€æŸ¥å¤±è´¥\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}\n\nå¯èƒ½çš„åŸå› :\n1. APIæœåŠ¡å™¨æœªå¯åŠ¨\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n3. CORSç­–ç•¥é™åˆ¶`, 'error');
            }
        }

        async function testStockInfo() {
            const resultId = 'stock-info-result';
            const stockCode = document.getElementById('stock-code-info').value;
            
            if (!stockCode) {
                showResult(resultId, 'âŒ è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            showLoading(resultId, 'æ­£åœ¨è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯...');
            
            try {
                const response = await fetch(`${API_BASE}/stock-info`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer xue1234',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        market_type: 'A'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    const stockInfo = data.data.stock_info;
                    showResult(resultId, `âœ… è‚¡ç¥¨ä¿¡æ¯è·å–æˆåŠŸ\nè‚¡ç¥¨åç§°: ${stockInfo.name}\nè‚¡ç¥¨ä»£ç : ${stockInfo.code}\nå½“å‰ä»·æ ¼: ${stockInfo.current_price}\næ¶¨è·Œå¹…: ${stockInfo.change_percent}%`, 'success');
                } else {
                    showResult(resultId, `âŒ è·å–å¤±è´¥\né”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}\nå®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMarketStatus() {
            const resultId = 'market-status-result';
            showLoading(resultId, 'æ­£åœ¨è·å–å¸‚åœºçŠ¶æ€...');
            
            try {
                const response = await fetch(`${API_BASE}/market-status`);
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    const marketStatus = data.data.market_status;
                    showResult(resultId, `âœ… å¸‚åœºçŠ¶æ€è·å–æˆåŠŸ\nå¸‚åœºçŠ¶æ€: ${marketStatus.market_status}\nå½“å‰æ—¶é—´: ${marketStatus.current_time}\näº¤æ˜“æ—¥: ${marketStatus.is_trading_day ? 'æ˜¯' : 'å¦'}`, 'success');
                } else {
                    showResult(resultId, `âŒ è·å–å¤±è´¥\né”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}\nå®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testStockAnalysis() {
            const resultId = 'analysis-result';
            const stockCode = document.getElementById('stock-code-analysis').value;
            
            if (!stockCode) {
                showResult(resultId, 'âŒ è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            showLoading(resultId, 'â³ æ­£åœ¨è¿›è¡Œç»¼åˆåˆ†æï¼Œè¯·ç¨å€™...\nè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿæ—¶é—´');
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${API_BASE}/analyze-stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer xue1234',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        market_type: 'A',
                        period: '30'
                    })
                });
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    const analysisData = data.data;
                    const stockInfo = analysisData.stock_info;
                    const technical = analysisData.technical_summary;
                    
                    const result = `âœ… ç»¼åˆåˆ†ææˆåŠŸ (è€—æ—¶: ${duration}ç§’)

ğŸ“Š è‚¡ç¥¨ä¿¡æ¯:
   åç§°: ${stockInfo.name}
   ä»£ç : ${stockInfo.code}
   å½“å‰ä»·æ ¼: ${stockInfo.current_price}
   æ¶¨è·Œå¹…: ${stockInfo.change_percent}%

ğŸ“ˆ æŠ€æœ¯åˆ†æ:
   è¶‹åŠ¿: ${technical.trend}
   RSI: ${technical.rsi}
   MA5: ${technical.ma5}
   MA10: ${technical.ma10}
   MA20: ${technical.ma20}
   æ”¯æ’‘ä½: ${technical.support_levels?.join(', ') || 'N/A'}
   é˜»åŠ›ä½: ${technical.resistance_levels?.join(', ') || 'N/A'}

ğŸ¯ è¿™ä¸ªå“åº”æ ¼å¼å¯ä»¥ç›´æ¥åœ¨Difyä¸­ä½¿ç”¨ï¼`;
                    
                    showResult(resultId, result, 'success');
                } else {
                    showResult(resultId, `âŒ åˆ†æå¤±è´¥ (è€—æ—¶: ${duration}ç§’)\né”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}\nå®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                showResult(resultId, `âŒ è¯·æ±‚å¤±è´¥ (è€—æ—¶: ${duration}ç§’)\né”™è¯¯: ${error.message}\n\nğŸ’¡ æç¤º: å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œè¯·åœ¨Difyä¸­è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
        window.onload = function() {
            setTimeout(testHealth, 1000);
        };
    </script>
</body>
</html>
