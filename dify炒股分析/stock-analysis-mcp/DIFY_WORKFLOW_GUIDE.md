# Difyå·¥ä½œæµé…ç½®æŒ‡å—

## ğŸ¯ æ¦‚è¿°

ç°åœ¨æ‚¨å¯ä»¥åœ¨Difyå·¥ä½œæµä¸­ä½¿ç”¨æˆ‘ä»¬çš„è‚¡ç¥¨åˆ†æHTTP APIæœåŠ¡ï¼è¿™ä¸ªæŒ‡å—å°†è¯¦ç»†è¯´æ˜å¦‚ä½•é…ç½®å·¥ä½œæµèŠ‚ç‚¹ã€‚

## ğŸš€ å‰ç½®å‡†å¤‡

### 1. å¯åŠ¨APIæœåŠ¡å™¨

åœ¨é¡¹ç›®ç›®å½•ä¸­è¿è¡Œï¼š
```bash
cd stock-analysis-mcp
python -m uvicorn api_server:app --host 0.0.0.0 --port 8003
```

### 2. éªŒè¯æœåŠ¡çŠ¶æ€

è®¿é—® `http://localhost:8003/health` ç¡®è®¤æœåŠ¡æ­£å¸¸è¿è¡Œã€‚

## ğŸ“Š APIæ¥å£è¯´æ˜

æˆ‘ä»¬æä¾›äº†4ä¸ªä¸»è¦æ¥å£ï¼š

### 1. `/analyze-stock` - ç»¼åˆè‚¡ç¥¨åˆ†æ â­æ¨è
**ç”¨é€”**: è·å–è‚¡ç¥¨çš„å®Œæ•´æŠ€æœ¯åˆ†ææŠ¥å‘Š
**æ–¹æ³•**: POST
**URL**: `http://localhost:8003/analyze-stock`

**è¯·æ±‚ä½“**:
```json
{
  "stock_code": "600132",
  "market_type": "A",
  "period": "30"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "success",
  "data": {
    "stock_info": {
      "code": "600132",
      "name": "é‡åº†å•¤é…’",
      "current_price": 55.14,
      "change_percent": 1.12
    },
    "technical_summary": {
      "trend": "éœ‡è¡",
      "ma5": 54.93,
      "ma10": 55.40,
      "ma20": 56.44,
      "rsi": 17.98,
      "support_levels": [55.23, 56.70],
      "resistance_levels": [59.60, 56.17]
    }
  }
}
```

### 2. `/stock-info` - è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
**ç”¨é€”**: è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å’Œå®æ—¶ä»·æ ¼
**æ–¹æ³•**: POST
**URL**: `http://localhost:8003/stock-info`

### 3. `/stock-history` - å†å²æ•°æ®
**ç”¨é€”**: è·å–è‚¡ç¥¨å†å²äº¤æ˜“æ•°æ®
**æ–¹æ³•**: POST
**URL**: `http://localhost:8003/stock-history`

### 4. `/market-status` - å¸‚åœºçŠ¶æ€
**ç”¨é€”**: è·å–å½“å‰å¸‚åœºå¼€ç›˜çŠ¶æ€
**æ–¹æ³•**: GET
**URL**: `http://localhost:8003/market-status`

## ğŸ”§ Difyå·¥ä½œæµé…ç½®æ­¥éª¤

### æ­¥éª¤1: é…ç½®å¼€å§‹èŠ‚ç‚¹

1. **æ·»åŠ è¾“å…¥å˜é‡**:
   - å˜é‡å: `stock_code`
   - ç±»å‹: `æ–‡æœ¬`
   - æè¿°: `è‚¡ç¥¨ä»£ç ï¼ˆå¦‚600132ï¼‰`

### æ­¥éª¤2: é…ç½®å˜é‡èšåˆå™¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå¯ä»¥æ·»åŠ å˜é‡èšåˆå™¨ï¼š
- **è¾“å…¥å˜é‡**: `stock_code`
- **è¾“å‡ºå˜é‡**: `processed_stock_code`

### æ­¥éª¤3: é…ç½®HTTPè¯·æ±‚èŠ‚ç‚¹ â­æ ¸å¿ƒ

1. **åŸºæœ¬è®¾ç½®**:
   - **æ–¹æ³•**: `POST`
   - **URL**: `http://localhost:8003/analyze-stock`
   - **è¶…æ—¶**: `60ç§’` (è‚¡ç¥¨æ•°æ®è·å–éœ€è¦æ—¶é—´)

2. **è¯·æ±‚å¤´**:
   ```
   Content-Type: application/json
   ```

3. **è¯·æ±‚ä½“**:
   ```json
   {
     "stock_code": "{{#stock_code#}}",
     "market_type": "A",
     "period": "30"
   }
   ```

4. **å˜é‡æ˜ å°„**:
   - å°†å¼€å§‹èŠ‚ç‚¹çš„ `stock_code` å˜é‡æ˜ å°„åˆ°è¯·æ±‚ä½“ä¸­

### æ­¥éª¤4: é…ç½®æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹

æ·»åŠ æ¡ä»¶åˆ¤æ–­æ¥å¤„ç†APIå“åº”ï¼š

**æ¡ä»¶1: æˆåŠŸå“åº”**
- **æ¡ä»¶**: `{{#http_request.body.status#}} == "success"`
- **åˆ†æ”¯**: ç»§ç»­å¤„ç†æ•°æ®

**æ¡ä»¶2: é”™è¯¯å“åº”**
- **æ¡ä»¶**: `{{#http_request.body.status#}} == "error"`
- **åˆ†æ”¯**: è¿”å›é”™è¯¯ä¿¡æ¯

### æ­¥éª¤5: é…ç½®æ•°æ®å¤„ç†èŠ‚ç‚¹

ä½¿ç”¨**ä»£ç æ‰§è¡Œ**èŠ‚ç‚¹æ¥æ ¼å¼åŒ–åˆ†æç»“æœï¼š

```python
def main(http_response: dict) -> dict:
    """å¤„ç†è‚¡ç¥¨åˆ†æç»“æœ"""
    
    if http_response.get('status') != 'success':
        return {
            'analysis_result': f"åˆ†æå¤±è´¥: {http_response.get('error', 'æœªçŸ¥é”™è¯¯')}"
        }
    
    data = http_response.get('data', {})
    stock_info = data.get('stock_info', {})
    technical = data.get('technical_summary', {})
    
    # æ ¼å¼åŒ–åˆ†ææŠ¥å‘Š
    report = f"""ğŸ“Š è‚¡ç¥¨åˆ†ææŠ¥å‘Š - {stock_info.get('name', 'N/A')} ({stock_info.get('code', 'N/A')})

ğŸ’° å½“å‰ä»·æ ¼: {stock_info.get('current_price', 'N/A')} å…ƒ
ğŸ“ˆ æ¶¨è·Œå¹…: {stock_info.get('change_percent', 'N/A')}%

ğŸ“Š è¶‹åŠ¿åˆ†æ: {technical.get('trend', 'N/A')}

ğŸ“ˆ ç§»åŠ¨å¹³å‡çº¿:
   MA5:  {technical.get('ma5', 'N/A')} å…ƒ
   MA10: {technical.get('ma10', 'N/A')} å…ƒ
   MA20: {technical.get('ma20', 'N/A')} å…ƒ

ğŸ¯ æŠ€æœ¯æŒ‡æ ‡:
   RSI: {technical.get('rsi', 'N/A')}

ğŸ¯ å…³é”®ä½ç½®:
   æ”¯æ’‘ä½: {', '.join(map(str, technical.get('support_levels', [])))}
   é˜»åŠ›ä½: {', '.join(map(str, technical.get('resistance_levels', [])))}

âš ï¸ ä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼"""
    
    return {
        'analysis_result': report,
        'raw_data': data
    }
```

### æ­¥éª¤6: é…ç½®è¾“å‡ºèŠ‚ç‚¹

è®¾ç½®æœ€ç»ˆè¾“å‡ºï¼š
- **è¾“å‡ºå˜é‡**: `analysis_result`
- **ç±»å‹**: `æ–‡æœ¬`

## ğŸ¨ å®Œæ•´å·¥ä½œæµç¤ºä¾‹

```
[å¼€å§‹] â†’ [å˜é‡èšåˆå™¨] â†’ [HTTPè¯·æ±‚] â†’ [æ¡ä»¶åˆ¤æ–­] â†’ [æ•°æ®å¤„ç†] â†’ [ç»“æŸ]
   â†“           â†“            â†“           â†“           â†“         â†“
stock_code  å¤„ç†è¾“å…¥    è°ƒç”¨API    æ£€æŸ¥çŠ¶æ€    æ ¼å¼åŒ–ç»“æœ   è¾“å‡ºæŠ¥å‘Š
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: HTTPè¯·æ±‚è¶…æ—¶
**è§£å†³æ–¹æ¡ˆ**: 
- å¢åŠ è¶…æ—¶æ—¶é—´åˆ°60-90ç§’
- æ£€æŸ¥APIæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

### é—®é¢˜2: æ— æ³•è¿æ¥åˆ°API
**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤APIæœåŠ¡å™¨å·²å¯åŠ¨ (`http://localhost:8003/health`)
- æ£€æŸ¥ç«¯å£8003æ˜¯å¦è¢«å ç”¨
- å¦‚æœDifyè¿è¡Œåœ¨Dockerä¸­ï¼Œä½¿ç”¨ `host.docker.internal:8003`

### é—®é¢˜3: è‚¡ç¥¨ä»£ç æ ¼å¼é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ä½¿ç”¨6ä½æ•°å­—æ ¼å¼ (å¦‚: 600132, 000001)
- åœ¨å˜é‡èšåˆå™¨ä¸­æ·»åŠ æ ¼å¼éªŒè¯

## ğŸ“ æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹1: æ­£å¸¸è‚¡ç¥¨
```json
{
  "stock_code": "600132",
  "market_type": "A", 
  "period": "30"
}
```

### æµ‹è¯•ç”¨ä¾‹2: æ·±åœ³è‚¡ç¥¨
```json
{
  "stock_code": "000001",
  "market_type": "A",
  "period": "30"
}
```

### æµ‹è¯•ç”¨ä¾‹3: é”™è¯¯ä»£ç 
```json
{
  "stock_code": "999999",
  "market_type": "A",
  "period": "30"
}
```

## ğŸ¯ ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**: å¯¹äºç›¸åŒè‚¡ç¥¨çš„é‡å¤è¯·æ±‚ï¼Œå¯ä»¥æ·»åŠ ç¼“å­˜é€»è¾‘
2. **æ‰¹é‡åˆ†æ**: å¯ä»¥æ‰©å±•APIæ”¯æŒå¤šåªè‚¡ç¥¨åŒæ—¶åˆ†æ
3. **å®æ—¶æ¨é€**: å¯ä»¥æ·»åŠ WebSocketæ”¯æŒå®æ—¶æ•°æ®æ¨é€
4. **é”™è¯¯é‡è¯•**: åœ¨HTTPè¯·æ±‚èŠ‚ç‚¹ä¸­é…ç½®é‡è¯•æœºåˆ¶

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„Difyå·¥ä½œæµå·²ç»å¯ä»¥ä½¿ç”¨ä¸“ä¸šçš„è‚¡ç¥¨åˆ†æåŠŸèƒ½äº†ï¼

ç›¸æ¯”ä¹‹å‰çš„æ–¹æ¡ˆï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå…·æœ‰ï¼š
- âœ… æ›´ç¨³å®šçš„æœ¬åœ°APIæœåŠ¡
- âœ… å®Œæ•´çš„æŠ€æœ¯åˆ†æåŠŸèƒ½
- âœ… æ ‡å‡†åŒ–çš„JSONå“åº”æ ¼å¼
- âœ… è¯¦ç»†çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… çµæ´»çš„å‚æ•°é…ç½®
