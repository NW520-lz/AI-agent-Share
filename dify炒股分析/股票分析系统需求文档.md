# 股票分析系统需求文档

## 1. 项目概述

### 1.1 项目背景
当前已在Dify平台上实现了股票分析系统的工作流，包括用户输入、参数校验和结果展示等环节。现需要开发本地Server端服务，通过HTTP接口与Dify工作流对接，实现股票数据获取、技术指标计算和分析报告生成功能。

### 1.2 项目目标
开发一个稳定、高效的本地服务器组件，作为股票分析系统的数据处理和分析引擎，为Dify工作流提供专业的股票分析能力。

## 2. 功能需求

### 2.1 核心API接口

#### 2.1.1 股票数据获取接口
- **接口名称**：`/analyze-stock/`
- **请求方式**：POST
- **接口描述**：根据股票代码和市场类型获取股票数据
- **请求参数**：
  - `stock_code`：股票代码（必填）
  - `market_type`：市场类型（必填，可选值：A、HK、US、ETF）
- **认证方式**：Bearer Token认证（`Authorization: bearer {apikey}`）
- **返回数据**：股票基础数据、技术指标和分析报告

#### 2.1.2 市场概览接口
- **接口名称**：`/market-overview/`
- **请求方式**：GET
- **接口描述**：获取指定市场的整体概况数据
- **请求参数**：
  - `market_type`：市场类型（可选，默认为A）
- **认证方式**：Bearer Token认证
- **返回数据**：市场总体情况、主要指数表现、行业板块分布

### 2.2 数据处理功能

#### 2.2.1 股票数据获取
- 支持从多个数据源获取股票历史交易数据（优先使用AKShare）
- 支持A股、港股、美股和ETF等多种市场类型
- 获取至少近14日的交易数据，包括开盘价、收盘价、最高价、最低价、成交量等

#### 2.2.2 技术指标计算
- 计算常用技术指标，包括但不限于：
  - 移动平均线（MA5、MA10、MA20、MA60）
  - MACD指标（DIF、DEA、MACD）
  - KDJ指标
  - RSI指标
  - 布林带
  - 成交量变化率

#### 2.2.3 分析报告生成
- 基于技术指标生成结构化的分析报告
- 报告内容包括：趋势判断、支撑压力位、成交量分析、风险评估等
- 提供适合AI模型处理的格式化数据

## 3. 技术要求

### 3.1 系统架构
- 采用Python FastAPI框架开发RESTful API服务
- 实现模块化设计，分离数据获取、指标计算和报告生成逻辑
- 支持水平扩展，以应对高并发请求

### 3.2 数据源管理
- 主要使用AKShare作为数据获取工具
- 实现数据源适配器模式，支持未来扩展其他数据源
- 建立本地数据缓存机制，减少对外部API的依赖

### 3.3 安全性要求
- 实现API密钥认证机制，确保只有授权客户端可以访问
- 添加请求频率限制，防止滥用
- 敏感配置信息（如第三方API密钥）通过环境变量或配置文件管理

### 3.4 性能要求
- API响应时间：平均<2秒，峰值<5秒
- 支持并发请求：至少10个并发请求
- 数据缓存机制：热门股票数据缓存时间不超过5分钟

## 4. 接口规范

### 4.1 请求示例

```json
POST /analyze-stock/
Authorization: bearer xue1234
Content-Type: application/json

{
  "stock_code": "000333",
  "market_type": "A"
}
```

### 4.2 响应示例

```json
{
  "status": "success",
  "data": {
    "stock_info": {
      "code": "000333",
      "name": "美的集团",
      "market": "A"
    },
    "technical_summary": {
      "trend": "上升",
      "ma5": 56.78,
      "ma10": 55.43,
      "ma20": 53.21,
      "macd": 1.25,
      "kdj_k": 75.6,
      "kdj_d": 68.3,
      "kdj_j": 82.9,
      "rsi": 65.7,
      "support_levels": [54.2, 52.8],
      "resistance_levels": [58.5, 60.2]
    },
    "recent_data": [
      {
        "date": "2023-05-24",
        "open": 56.2,
        "close": 57.8,
        "high": 58.1,
        "low": 56.0,
        "volume": 12345678
      }
    ],
    "report": {
      "trend_analysis": "股票呈现上升趋势，近期突破60日均线...",
      "volume_analysis": "成交量温和放大，表明买盘力量增强...",
      "risk_assessment": "短期RSI达到65.7，接近超买区域，存在回调风险...",
      "support_resistance": "近期支撑位在54.2元，压力位在58.5元...",
      "trading_suggestion": "可考虑在回调至支撑位附近买入，止损设置在52.8元以下..."
    }
  }
}
```

## 5. 开发计划

### 5.1 阶段划分

#### 阶段一：基础架构搭建（预计1周）
- 搭建FastAPI服务框架
- 实现认证机制
- 设计数据模型和接口规范

#### 阶段二：核心功能开发（预计2周）
- 实现股票数据获取模块
- 开发技术指标计算模块
- 完成分析报告生成逻辑

#### 阶段三：优化与测试（预计1周）
- 实现数据缓存机制
- 进行性能优化
- 完成接口测试和压力测试

### 5.2 关键里程碑
- T+7天：完成基础架构搭建，提供简单的数据获取接口
- T+21天：完成所有核心功能开发，支持完整的股票分析流程
- T+28天：系统优化完成，达到生产环境部署标准

## 6. 集成方案

### 6.1 与Dify工作流集成
- 在Dify工作流中配置HTTP请求节点，指向本地Server的API接口
- 使用环境变量存储API密钥，确保安全传输
- 在Dify中处理API返回的结构化数据，生成用户友好的分析结果

### 6.2 部署方案
- 本地服务器采用Docker容器化部署
- 配置Nginx作为反向代理，提供HTTPS访问
- 确保本地服务器IP地址或域名可被Dify平台访问

## 7. 验收标准

### 7.1 功能验收
- 所有API接口按规范实现并正常工作
- 支持所有指定的市场类型和技术指标
- 分析报告内容完整、准确、专业

### 7.2 性能验收
- API响应时间符合性能要求
- 系统能够处理指定的并发请求数
- 数据缓存机制有效运行

### 7.3 安全验收
- 认证机制有效，未授权请求被正确拒绝
- 敏感信息不在日志或响应中泄露
- 请求频率限制正常工作

## 8. 风险与应对措施

### 8.1 已识别风险
1. **数据源不稳定**：AKShare或其他数据源可能出现不稳定或限流
   - 应对措施：实现多数据源切换机制，增加本地数据缓存
   
2. **分析精度问题**：技术指标计算可能存在精度偏差
   - 应对措施：与专业金融软件对比验证，确保计算准确性
   
3. **系统负载过高**：高并发请求可能导致系统负载过高
   - 应对措施：实现请求队列和任务调度，优化资源利用

### 8.2 应急预案
- 建立系统监控机制，及时发现并处理异常
- 准备备用数据源，在主数据源不可用时自动切换
- 设计降级策略，在系统负载过高时返回缓存数据或简化分析结果

## 9. 附录

### 9.1 术语表
- **Dify**：AI应用开发平台，用于构建工作流
- **AKShare**：开源的Python金融数据接口库
- **技术指标**：用于股票技术分析的数学计算指标
- **FastAPI**：高性能的Python Web框架

### 9.2 参考资料
- AKShare官方文档：https://akshare.akfamily.xyz/
- FastAPI官方文档：https://fastapi.tiangolo.com/
- 技术分析指标计算方法：https://www.investopedia.com/terms/t/technicalindicator.asp

---

文档编制：[产品经理姓名]  
版本：V1.0  
日期：2023年5月25日
